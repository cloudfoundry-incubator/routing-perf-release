#!/bin/bash -l

set -e

DIR=`dirname $0`

<% p("performance_tests.routers").each do |router| %>
  tmpfile=$(mktemp)
  ${DIR}/run_perf_test <%= router["address"] %> <%= router["tag"] %> > ${tmpfile} &
  PIDS="${PIDS} $!"
  TMPFILES="${TMPFILES} ${tmpfile}"
<% end %>

set +e
for PID in ${PIDS}; do
  wait ${PID}
  EXIT_STATUSES="${EXIT_STATUSES} $?"
done
set -e

for TMPFILE in ${TMPFILES}; do
  cat $TMPFILE
done

for EXIT_STATUS in ${EXIT_STATUSES}; do
  if [ ${EXIT_STATUS} -gt 0 ] ; then
    exit 1
  fi
done
